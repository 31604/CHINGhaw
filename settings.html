<?php require "auth.php"; ?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Settings - IoT Dashboard</title>
<style>
body{
  font-family:Arial, sans-serif;
  margin:0; padding:0;
  background:#f8fafc; color:#1e293b;
  transition: background 0.3s, color 0.3s;
}
body.dark{ background:#1e293b; color:white; }

.topbar{
  position:fixed; top:0; left:0; right:0; height:55px;
  background:#1e293b; color:white; display:flex;
  align-items:center; justify-content:space-between; padding:0 20px; z-index:999; font-weight:600;
}

#menuButton, #themeButton{
  border:none; border-radius:5px; cursor:pointer;
}
#menuButton{ background:#3b82f6; color:white; font-size:22px; padding:6px 10px; }
#menuButton:hover{ background:#2563eb; }
#menuButton.open{ transform:rotate(90deg); }
#themeButton{ background:#fbbf24; color:white; font-size:14px; padding:6px 10px; }

#sidebar{
  position:fixed; top:0; left:-280px; width:280px; height:100%;
  background:#1e293b; color:white; padding:20px; transition:left 0.3s ease; z-index:1000;
  display:flex; flex-direction:column; gap:15px; overflow-y:auto;
}
#sidebar.active{ left:0; }
#sidebar h2{ margin-top:0; color:#3b82f6; }
#sidebar a{ color:white; text-decoration:none; padding:8px 12px; border-radius:5px; }
#sidebar a:hover{ background:#334155; }

.container{ padding:80px 20px; max-width:900px; margin:auto; }
.panel{ background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:20px; }
.panel.dark{ background:#334155; color:white; }

h1{text-align:center; margin-top:60px; margin-bottom:20px;}
label{display:block; margin:10px 0 5px;}
input[type=text], input[type=number]{ width:100%; padding:8px; border-radius:5px; border:1px solid #cbd5e1; }
button{ margin-top:10px; padding:8px 12px; border:none; border-radius:5px; cursor:pointer; background:#3b82f6; color:white; }
button:hover{ background:#2563eb; }
.status{ margin-top:5px; font-weight:bold; }
.status.success{ color:green; }
.status.error{ color:red; }
</style>
</head>
<body>

<div class="topbar">
  <button id="menuButton" onclick="toggleSidebar()">‚ò∞</button>
  <div>Settings</div>
  <button id="themeButton" onclick="toggleTheme()">üåó</button>
</div>

<div id="sidebar">
  <h2>Menu</h2>
  <a href="index.html">üè† Dashboard</a>
  <a href="alerts.html">üö® Alerts</a>
  <a href="devices.html">üñ•Ô∏è Devices</a>
  <a href="settings.html">‚öôÔ∏è Settings</a>
  <a href="help.html">‚ùì Help</a>
  <a href="about.html">‚ÑπÔ∏è About</a>
  <a href="login.html">üîí Logout</a>
</div>

<div class="container">
  <h1>Device & Sensor Settings</h1>

  <div class="panel">
    <h3>Raspberry Pi Configuration</h3>
    <label for="raspIP">Raspberry IP:</label>
    <input type="text" id="raspIP" placeholder="192.168.x.x">

    <label for="raspPort">Port:</label>
    <input type="number" id="raspPort" placeholder="80">

    <button onclick="saveRaspberrySettings()">Save Raspberry Settings</button>
    <div id="raspStatus" class="status"></div>
  </div>

  <div class="panel">
    <h3>Sensor Thresholds</h3>
    <div id="sensorsContainer">
      <p>Loading sensors...</p>
    </div>
    <button onclick="saveSensorSettings()">Save Sensor Settings</button>
    <div id="sensorStatus" class="status"></div>
  </div>
</div>

<script>
/* === Sidebar & Theme === */
function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("active"); document.getElementById("menuButton").classList.toggle("open"); }
function toggleTheme(){ 
  document.body.classList.toggle("dark"); 
  document.querySelectorAll(".panel").forEach(el=>el.classList.toggle("dark")); 
  localStorage.setItem("theme", document.body.classList.contains("dark")?"dark":"light");
}
const theme = localStorage.getItem("theme") || "light";
document.body.classList.toggle("dark", theme==="dark");

/* === Raspberry Settings === */
const raspIPInput=document.getElementById("raspIP");
const raspPortInput=document.getElementById("raspPort");
const raspStatus=document.getElementById("raspStatus");

// Load saved settings
if(localStorage.getItem("raspIP")) raspIPInput.value=localStorage.getItem("raspIP");
if(localStorage.getItem("raspPort")) raspPortInput.value=localStorage.getItem("raspPort");

function saveRaspberrySettings(){
  const ip=raspIPInput.value.trim();
  const port=raspPortInput.value.trim();
  if(!ip || !port){ raspStatus.textContent="Please fill all fields"; raspStatus.className="status error"; return; }
  localStorage.setItem("raspIP", ip);
  localStorage.setItem("raspPort", port);
  raspStatus.textContent="Raspberry settings saved!";
  raspStatus.className="status success";
}

/* === Sensors Settings === */
const sensorsContainer=document.getElementById("sensorsContainer");

async function loadSensors(){
  const raspIP=localStorage.getItem("raspIP")||"192.168.43.180";
  const raspPort=localStorage.getItem("raspPort")||"80";
  try{
    const res=await fetch(`http://${raspIP}:${raspPort}/sensors`);
    const sensors=await res.json();
    if(sensors.length===0){ sensorsContainer.innerHTML="<p>No sensors found</p>"; return; }

    sensorsContainer.innerHTML="";
    sensors.forEach(s=>{
      const div=document.createElement("div");
      div.innerHTML=`<label>${s.name} (Threshold):</label>
        <input type="number" value="${s.threshold||0}" data-sensor="${s.id}">`;
      sensorsContainer.appendChild(div);
    });
  }catch(e){
    sensorsContainer.innerHTML="<p>Failed to load sensors</p>";
    console.error(e);
  }
}

async function saveSensorSettings(){
  const raspIP=localStorage.getItem("raspIP")||"192.168.43.180";
  const raspPort=localStorage.getItem("raspPort")||"80";
  const inputs=sensorsContainer.querySelectorAll("input");
  const data=[];
  inputs.forEach(i=>{ data.push({id:i.dataset.sensor, threshold:parseFloat(i.value)}); });

  try{
    const res=await fetch(`http://${raspIP}:${raspPort}/sensors`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(data)
    });
    if(res.ok){ 
      document.getElementById("sensorStatus").textContent="Sensor settings saved!";
      document.getElementById("sensorStatus").className="status success";
    }else throw new Error("Failed to save");
  }catch(e){
    document.getElementById("sensorStatus").textContent="Error saving sensor settings";
    document.getElementById("sensorStatus").className="status error";
    console.error(e);
  }
}

// Load sensors on page load
loadSensors();
</script>

</body>
</html>