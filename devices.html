<?php require "auth.php"; ?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Devices - IoT Dashboard</title>
<style>
body{
  font-family:Arial, sans-serif;
  margin:0; padding:0;
  background:#f8fafc; color:#1e293b;
  transition: background 0.3s, color 0.3s;
}
body.dark{ background:#1e293b; color:white; }

.topbar{
  position:fixed; top:0; left:0; right:0; height:55px;
  background:#1e293b; color:white; display:flex;
  align-items:center; justify-content:space-between; padding:0 20px; z-index:999; font-weight:600;
}

#menuButton, #themeButton{
  border:none; border-radius:5px; cursor:pointer;
}
#menuButton{ background:#3b82f6; color:white; font-size:22px; padding:6px 10px; }
#menuButton:hover{ background:#2563eb; }
#menuButton.open{ transform:rotate(90deg); }
#themeButton{ background:#fbbf24; color:white; font-size:14px; padding:6px 10px; }

#sidebar{
  position:fixed; top:0; left:-280px; width:280px; height:100%;
  background:#1e293b; color:white; padding:20px; transition:left 0.3s ease; z-index:1000;
  display:flex; flex-direction:column; gap:15px; overflow-y:auto;
}
#sidebar.active{ left:0; }
#sidebar h2{ margin-top:0; color:#3b82f6; }
#sidebar a{ color:white; text-decoration:none; padding:8px 12px; border-radius:5px; }
#sidebar a:hover{ background:#334155; }

.container{ padding:80px 20px; max-width:1300px; margin:auto; }
.panel{ background:white; padding:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:20px; }
.panel.dark{ background:#334155; color:white; }

h1{text-align:center; margin-top:60px; margin-bottom:20px;}
table{ width:100%; border-collapse:collapse; }
table th, table td{ padding:12px; border-bottom:1px solid #cbd5e1; text-align:left; }
table th{ background:#3b82f6; color:white; }
body.dark table th{ background:#2563eb; }
body.dark table td{ border-bottom:1px solid #64748b; }
.status-active{ color:green; font-weight:bold; }
.status-inactive{ color:red; font-weight:bold; }
</style>
</head>
<body>

<div class="topbar">
  <button id="menuButton" onclick="toggleSidebar()">‚ò∞</button>
  <div>Devices</div>
  <button id="themeButton" onclick="toggleTheme()">üåó</button>
</div>

<div id="sidebar">
  <h2>Menu</h2>
  <a href="dashboard.php">üè† Dashboard</a>
  <a href="alerts.html">üö® Alerts</a>
  <a href="devices.html">üñ•Ô∏è Devices</a>
  <a href="settings.html">‚öôÔ∏è Settings</a>
  <a href="help.html">‚ùì Help</a>
  <a href="about.html">‚ÑπÔ∏è About</a>
  <a href="index.php">üîí Logout</a>
</div>

<div class="container">
  <h1>Connected Devices</h1>
  <div class="panel">
    <table id="devicesTable">
      <thead>
        <tr>
          <th>Device Name</th>
          <th>Type</th>
          <th>Status</th>
          <th>Last Active</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4">Loading devices...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* === Sidebar & Theme === */
function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("active"); document.getElementById("menuButton").classList.toggle("open"); }
function toggleTheme(){ 
  document.body.classList.toggle("dark"); 
  document.querySelectorAll(".panel").forEach(el=>el.classList.toggle("dark")); 
  localStorage.setItem("theme", document.body.classList.contains("dark")?"dark":"light");
}
const theme = localStorage.getItem("theme") || "light";
document.body.classList.toggle("dark", theme==="dark");

/* === Devices Fetch === */
const raspberryIP="192.168.43.180";
async function fetchDevices(){
  try{
    const response=await fetch(`http://${raspberryIP}/devices`);
    const devices=await response.json();
    const tbody=document.querySelector("#devicesTable tbody");
    tbody.innerHTML="";
    if(devices.length===0){ tbody.innerHTML="<tr><td colspan='4'>No devices connected</td></tr>"; return; }
    devices.forEach(d=>{
      const statusClass=d.status.toLowerCase()==="active"?"status-active":"status-inactive";
      const lastActive=new Date(d.last_active).toLocaleString();
      tbody.innerHTML+=`<tr>
        <td>${d.name}</td>
        <td>${d.type}</td>
        <td class="${statusClass}">${d.status}</td>
        <td>${lastActive}</td>
      </tr>`;
    });
  }catch(e){ console.error(e); document.querySelector("#devicesTable tbody").innerHTML="<tr><td colspan='4'>Failed to fetch devices</td></tr>"; }
}

/* Auto-update every 5 sec */
fetchDevices();
setInterval(fetchDevices,5000);
</script>

</body>
</html>